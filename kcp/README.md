# intro
KCP 是一個快速可靠協議，
- 能以比 TCP 浪費 10~20 % 的帶寬為代價，換取平均延遲降低 30~40 %
- 最大延遲降低三倍的傳輸效果
- 純演算法實現，並不負責底層協議(如UDP)的收發
- 需要使用者自己定義底層數據包的發送方式，以 callback 方式提供給 KCP

### KCP 封包
```md
0               4   5   6       8 (BYTE)
+---------------+---+---+-------+
|     conv      |cmd|frg|  wnd  |
+---------------+---+---+-------+   8
|     ts        |     sn        |
+---------------+---------------+  16
|     una       |     len       |
+---------------+---------------+  24
|                               |
|        DATA (optional)        |
|                               |
+-------------------------------+
```

### 帶寬
單位時間內(一般指 1 秒)，能傳送的數據量
e.g. 網路之餘高速公路類似，帶寬越大之餘高速公路的車道越多，其通行能力越強

### KCP 是什麼?
1. 狹義上 KCP 並不是一種網路傳輸協議，他是基於 UDP 寫的可靠傳蘇算法
2. 它把 TCP 的主要可靠傳輸機制移植到 UDP 上，讓 UDP 變得可靠起來

### 重點名詞
- ARQ, Automatic Repeat-reQuest
	1. TCP 可靠機制，自動重傳請求(ARQ)，屬於OSI模型中`數據鏈路層(L2)`的錯誤糾正協議之一
	2. ARQ 因為現在鏈路的性能較好，目前在`數據鏈路層(L2)`很少採用
	3. TL;DR : TCP 的可靠性傳輸機制是在`傳輸層(L4)`完成的，而可靠機制原理應用的是ARQ的工作原理

- 停等式 ARQ (stop-and-wait)

- 連續 ARQ
	1. 回退 n 幀 (go-back-in)
	2. 選擇重傳協議 (selective repeat)

- 滑動窗口協議 (sliding winodw)

回退 n 幀 (go-back-in) 和 選擇重傳(selective repeat) 是`滑動窗口`技術與`請求重發`技術的結合，又稱其為`連續ARQ協議`

區別在於出錯的數據報文的處理機制不同

### KCP 和 TCP 的對比
1. 選擇性重傳 vs 全部重傳
	- TCP 丟包時會全部重傳(go-back-in)，從丟的那個包開始以後的數據，KCP是選擇性重傳，只重傳真正丟失的數據包
2. 快速重傳
	- 發送端給了 1,2,3,4,5 個包，然後接收端收到 1,3,4,5
	> 當收到 ACK3 時，KCP 知道 2 被跳過 1 次
	> 當收到 ACK4 時，KCP 知道 2 被跳過 2 次，此時可以認為 2 丟失，不用等待超時，直接重傳 2
3. 延遲 ACK vs 非延遲 ACK
	<!-- Round Trip Time 封包來回時間 -->
	- TCP 為充分利用帶寬，延遲發送 ACK (NODELAY也沒用)，致使RTT(Round Trip Time)增加
	- KCP 的 ACK延遲 可以透過設定調整
4. UNA vs ACK+UNA
	- ARQ 模型響應有兩種，UNA(此編號前所有包已收到, e.g. TCP)和 ACK(該編號包已收到)
	- 光用 UNA 將導致全部重傳
	- 光用 ACK 則丟失成本太高
	- KCP 協議中，除去單獨的 ACK 包外，所有包都有 UNA 信息
5. 非退讓流控
	- KCP 正常模式同 TCP 一樣使用公平退讓法則:
		- 即發送窗口大小由: 發送緩存大小、接收端剩餘緩存大小、丟包及緩啟動等四要素決定
		- 但傳送即時性要求很高的小數據時，後兩者可以略過
	> 透過犧牲部分公平性及帶寬利用率，換取傳輸速度


# refer:
- https://www.daimajiaoliu.com/daima/4797367f39003fc
- https://github.com/skywind3000/kcp
- https://github.com/xtaci/kcp-go
<!-- extend refer kcptun -->
- https://zhuanlan.zhihu.com/p/53849089
